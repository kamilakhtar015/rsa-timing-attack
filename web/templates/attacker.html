<!DOCTYPE html>
<html>
<head>
  <title>Attacker - Timing Side Channel</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>🧠 Attacker - Timing Side Channel Simulation</h2>

  <p>
    This simulates a timing side-channel attack on RSA. Crafted ciphertexts are sent and the attacker guesses bits based on decryption delays.
  </p>

  <button onclick="runAttack()">🔁 Run Timing Attack</button>
  <button onclick="replayLast()">🔁 Replay Last Message</button>

  <canvas id="timingChart" width="900" height="400"></canvas>

  <div style="margin-top: 40px;">
    <h3>🧩 Guessed Bits</h3>
    <table border="1" id="bit-table" style="border-collapse: collapse;"></table>
  </div>

  <script>
    let chart;
  
    function renderChart(data) {
      const labels = data.map((r, i) => r.replay ? `Replay ${i + 1}` : `#${i + 1}`);
      const times = data.map(r => r.time);
  
      // Define the colors for each bit guess and replay
      const colors = data.map(r => {
        if (r.replay) return 'rgba(0, 255, 0, 0.7)';  // Green for replay (with transparency)
        return r.bit_guess === 1 ? 'rgba(255, 0, 0, 0.7)' : 'rgba(0, 0, 255, 0.7)';  // Red for 1, Blue for 0 (with transparency)
      });
  
      // Define the labels for the legend
      const legendLabels = {
        '1': ' = 1 (Red)',
        '0': ' = 0 (Blue)',
        'replay': ' = Replay (Green)'
      };
  
      // Destroy any existing chart
      if (chart) chart.destroy();
      
      // Create new chart with updated colors and custom legend
      chart = new Chart(document.getElementById("timingChart"), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Decryption Time (seconds)',
            data: times,
            backgroundColor: colors,  // Set background color for each bar
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: '⏱️ Timing Analysis'
            },
            legend: {
              labels: {
                // Custom legend item text and color (manually set the colors for the legend items)
                generateLabels: function(chart) {
                  return [
                    { text: legendLabels['1'], fillStyle: 'rgba(255, 0, 0, 0.7)' }, // Red for 1
                    { text: legendLabels['0'], fillStyle: 'rgba(0, 0, 255, 0.7)' }, // Blue for 0
                    { text: legendLabels['replay'], fillStyle: 'rgba(0, 255, 0, 0.7)' } // Green for Replay
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Decryption Time (s)'
              }
            }
          }
        }
      });
  
      // Render guessed bits table
      const bitRow = data.map(r => `<td>${r.bit_guess}</td>`).join('');
      document.getElementById("bit-table").innerHTML = `<tr>${bitRow}</tr>`;
    }
  
    function runAttack() {
      fetch('/run-attacker', { method: 'POST' })
        .then(() => fetch('/api/attacker/bit-recovery'))
        .then(res => res.json())
        .then(data => renderChart(data.data));
    }
  
    function replayLast() {
      fetch('/replay-last', { method: 'POST' })
        .then(() => fetch('/api/attacker/bit-recovery'))
        .then(res => res.json())
        .then(data => renderChart(data.data));
    }
  </script>
        
</body>
</html>